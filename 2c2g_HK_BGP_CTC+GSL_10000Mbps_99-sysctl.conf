# 10Gbps带宽2核2G内存VPS优化配置（抗丢包增强版）
# 核心目标：10Gbps带宽充分利用 + 上下行对称 + 单线程性能 + 低延迟 + 减少丢包
# 硬件约束：2核CPU、2GB内存（严格控制内存占用≤70%）

# BDP计算（抗丢包适配）：
# 10Gbps理论速度=1.25GB/s，RTT=20ms时BDP=25MB
# 缓冲区总占用控制在内存30%以内（约600MB），预留足够空间应对突发丢包

# TCP窗口核心配置（上下行对称+抗丢包）
net.ipv4.tcp_rmem = 8388608 134217728 268435456   # 接收窗口：8MB初始（加速恢复）-128MB-256MB
net.ipv4.tcp_wmem = 8388608 134217728 268435456   # 发送窗口：与接收严格对称
net.core.rmem_default = 67108864                  # 接收默认64MB（对称分配）
net.core.wmem_default = 67108864                  # 发送默认64MB（对称分配）
net.core.rmem_max = 268435456                     # 接收最大256MB（2G内存安全上限）
net.core.wmem_max = 268435456                     # 发送最大256MB（与接收对称）
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_moderate_rcvbuf = 1                  # 动态调整缓冲区（根据丢包自适应）
net.ipv4.tcp_adv_win_scale = -2                   # 激进窗口扩展（降低RTT影响）
net.ipv4.tcp_low_latency = 1                      # 低延迟模式
net.ipv4.tcp_sack = 1                             # 启用SACK（精准定位丢包）
net.ipv4.tcp_fack = 1                             # 转发确认（辅助SACK）
net.ipv4.tcp_timestamps = 1                       # 时间戳（SACK依赖）

# BBR拥塞控制（10Gbps抗丢包调优）
net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_bbr_high_gain = 3200000000           # 中等增益（平衡速度与丢包）
net.ipv4.tcp_bbr_rtt_scaling = 1                  # 高RTT敏感度（及时响应丢包）
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_no_metrics_save = 1                  # 减少单线程开销
net.ipv4.tcp_bbr_min_rtt_window = 500000          # 缩短RTT采样窗口（更快检测丢包）
net.ipv4.tcp_bbr_probe_rtt_mode = 1               # 启用RTT探测（预防路径拥塞丢包）

# 单线程性能与丢包恢复
net.ipv4.tcp_limit_output_bytes = 16777216        # 单次发送16MB（2核处理能力内）
net.ipv4.tcp_single_stream_allowance = 134217728  # 单流限制128MB（匹配2核）
net.ipv4.tcp_push_pending_frames = 1              # 立即发送（减少缓冲延迟）
net.ipv4.tcp_nodelay = 1                          # 禁用Nagle（小包无延迟）
net.ipv4.tcp_autocorking = 0                      # 禁用自动合并（避免人为延迟）
net.ipv4.tcp_reordering = 6                       # 提高乱序容忍（减少误判丢包）
net.ipv4.tcp_early_retrans = 3                    # 早期重传（加速丢包恢复）
net.ipv4.tcp_lost_retransmit = 1                  # 丢包后立即重传

# 网络设备队列（防丢包核心）
net.core.netdev_max_backlog = 200000              # 接收队列20万（10Gbps突发缓冲）
net.core.netdev_budget = 600                      # 单次中断处理包数（2核适配）
net.core.netdev_budget_usecs = 2000               # 中断处理时间限制
net.core.dev_weight = 512                         # 设备权重（2核均衡负载）
net.core.optmem_max = 8388608                     # 选项内存8MB（2核够用）
net.core.busy_poll = 300                          # 忙轮询（2核合理利用）
net.core.busy_read = 300                          # 忙读（平衡CPU与延迟）
net.core.default_qdisc = fq_codel                 # FQ_Codel主动控延迟+防丢包
net.core.fq_codel.target = 3ms                    # 目标延迟3ms（减少主动丢包）
net.core.fq_codel.interval = 100ms                # 检查间隔100ms
net.core.fq_codel.limit = 20000                   # 队列长度（10Gbps突发缓冲）
net.core.fq_codel.flows = 16384                   # 流数量（上下行公平调度）
net.core.fq_codel.burst = 50                      # 允许短突发（减少正常波动丢包）

# 连接管理（减少连接异常丢包）
net.core.somaxconn = 131072                       # 连接队列13万（2核支撑）
net.ipv4.tcp_max_syn_backlog = 65536              # SYN队列6.5万
net.ipv4.tcp_max_tw_buckets = 1000000             # TIME_WAIT桶100万（2G内存可控）
net.ipv4.tcp_fin_timeout = 2                      # 适度延长FIN等待（减少半连接丢包）
net.ipv4.tcp_tw_reuse = 1                         # 重用TIME_WAIT（节省资源）
net.ipv4.tcp_orphan_retries = 1                   # 轻微增加重试（减少意外丢包）
net.ipv4.tcp_abort_on_overflow = 0                # 溢出时缓冲而非直接丢包
net.ipv4.tcp_dsack = 1                            # 重复SACK（精准定位丢包）
net.ipv4.tcp_syncookies = 1                       # 防御SYN泛洪丢包

# 超时与重传（加速丢包恢复）
net.ipv4.tcp_keepalive_time = 20                  # 保活探测20秒
net.ipv4.tcp_keepalive_intvl = 2                  # 探测间隔2秒
net.ipv4.tcp_keepalive_probes = 3                 # 探测次数3次
net.ipv4.ip_local_port_range = 1024 65535
net.ipv4.tcp_retries1 = 2                         # 初始重传等待减少
net.ipv4.tcp_retries2 = 8                         # 最大重传次数增加
net.ipv4.tcp_rto_min = 200                        # 最小重传超时200ms
net.ipv4.tcp_rto_max = 2000                       # 最大重传超时2s

# 内存管理（2G内存抗丢包保障）
vm.swappiness = 0                                 # 禁用交换（交换=高延迟+丢包）
vm.min_free_kbytes = 262144                       # 保留256MB空闲内存（应对突发）
vm.dirty_ratio = 10                               # 脏页比率10%（避免I/O阻塞丢包）
vm.dirty_background_ratio = 5                     # 后台脏页5%
vm.dirty_writeback_centisecs = 50                 # 50ms刷盘一次
vm.page-cluster = 0                               # 禁用预读（消除延迟）
vm.max_map_count = 262144                         # 映射限制（2G适配）

# 系统限制（2核支撑配置）
fs.file-max = 2097152                             # 文件描述符200万
fs.nr_open = 4194304                              # 进程描述符400万
net.ipv4.tcp_max_orphans = 65536                  # 孤儿连接限制（2核适配）

# 处理器调度（2核抗丢包优化）
kernel.sched_migration_cost_ns = 100000           # 进程迁移成本（2核均衡）
kernel.sched_autogroup_enabled = 0                # 禁用自动分组
kernel.sched_latency_ns = 1000000                 # 调度延迟1ms（快速响应）
kernel.sched_wakeup_granularity_ns = 250000       # 唤醒粒度0.25ms
kernel.softirq_prio = 6                           # 提高软中断优先级（确保丢包处理）

# 硬件加速（2核扛10Gbps关键）
net.ipv4.tcp_tso = 1                              # 发送分段卸载（节省CPU）
net.ipv4.tcp_gro = 1                              # 接收聚合卸载
net.ipv4.tcp_lro = 1                              # 大型接收卸载
net.ipv4.tcp_ecn = 2                              # 启用ECN（用标记替代丢包）
net.core.netdev_features = 0xffffffff             # 启用所有支持的网卡特性
