# 1000Mbps对等带宽单线程满速优化配置（增强版）
# 解决单线程速率不足问题，重点提升单流吞吐量

# BDP重新计算（针对单线程满速）：
# 1000Mbps = 125MB/s（理论最大单线程速度）
# 假设RTT=20ms，所需窗口=125MB/s × 0.02s = 2.5MB
# 为覆盖更高延迟场景（30ms），窗口上限提升至4MB

# 1. TCP窗口核心优化（关键调整）
net.ipv4.tcp_rmem = 2097152 4194304 8388608  # 接收窗口：2MB - 4MB - 8MB
net.ipv4.tcp_wmem = 2097152 4194304 8388608  # 发送窗口：2MB - 4MB - 8MB
net.core.rmem_default = 4194304              # 默认接收缓冲区4MB
net.core.wmem_default = 4194304              # 默认发送缓冲区4MB
net.core.rmem_max = 8388608                  # 最大接收缓冲区8MB
net.core.wmem_max = 8388608                  # 最大发送缓冲区8MB
net.ipv4.tcp_window_scaling = 1              # 启用窗口缩放（必须开启）
net.ipv4.tcp_moderate_rcvbuf = 0             # 禁用自动调整缓冲区（关键）

# 2. BBR拥塞控制增强（单流优化）
net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_bbr_high_gain = 3000000000      # 提高BBR增益（默认281474976710656）
net.ipv4.tcp_bbr_rtt_scaling = 2             # 优化RTT响应
net.ipv4.tcp_slow_start_after_idle = 0        # 空闲不重置慢启动（核心）
net.ipv4.tcp_no_metrics_save = 1              # 不保存连接状态

# 3. 单线程性能突破（重点增强）
net.ipv4.tcp_limit_output_bytes = 4194304     # 单次发送上限提升至4MB（原1MB）
net.ipv4.tcp_single_stream_allowance = 20971520  # 单流允许带宽提升至20MB
net.ipv4.tcp_push_pending_frames = 1          # 立即发送 pending 帧
net.ipv4.tcp_nodelay = 1                      # 禁用Nagle算法（减少延迟）

# 4. 网络设备队列优化
net.core.netdev_max_backlog = 100000          # 接收队列提升至10万（原5万）
net.core.dev_weight = 128                     # 设备处理权重翻倍
net.core.busy_poll = 50                       # 忙轮询机制减少延迟
net.core.busy_read = 50                       # 忙读机制提升响应速度

# 5. 连接管理强化
net.core.somaxconn = 131072                   # 最大连接队列提升至13万
net.ipv4.tcp_max_syn_backlog = 65536          # SYN队列翻倍
net.ipv4.tcp_max_tw_buckets = 4000000         # TIME_WAIT桶数量翻倍
net.ipv4.tcp_fin_timeout = 2                  # 进一步缩短FIN等待时间
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_orphan_retries = 1               # 减少孤儿连接重试

# 6. 超时与保活优化
net.ipv4.tcp_keepalive_time = 30              # 保活探测时间缩短至30秒
net.ipv4.tcp_keepalive_intvl = 5              # 保活间隔缩短至5秒
net.ipv4.ip_local_port_range = 1024 65535

# 7. 内存管理优化（避免瓶颈）
vm.swappiness = 0                             # 彻底禁用交换
vm.min_free_kbytes = 131072                   # 保留128MB空闲内存
vm.dirty_ratio = 40                           # 脏页比率提高至40%
vm.dirty_background_ratio = 20                # 后台脏页比率提高至20%
vm.dirty_writeback_centisecs = 50             # 50ms写回脏页（更频繁）
vm.page-cluster = 0                           # 禁用页面聚类（减少延迟）

# 8. 系统限制解除
fs.file-max = 20971520                        # 文件描述符限制翻倍
fs.nr_open = 4194304
net.ipv4.ip_unprivileged_port_start = 0       # 允许所有端口使用

# 9. 处理器调度优化
kernel.sched_migration_cost_ns = 50000        # 减少进程迁移
kernel.sched_autogroup_enabled = 0            # 禁用自动分组
kernel.sched_latency_ns = 2000000            # 调度延迟降至2ms

# 10. 网络接口硬件加速（需配合ethtool设置）
net.ipv4.tcp_tso = 1                          # 启用TCP分段卸载
net.ipv4.tcp_gro = 1                          # 启用通用接收卸载