# 10Gbps带宽2核2G内存VPS优化配置（抗丢包增强版）
# 核心目标：2000Mbps带宽充分利用 + 上下行对称 + 单线程性能 + 低延迟 + 减少丢包
# 硬件约束：2核CPU(AMD EPYC 7663)、2GB内存（严格控制内存占用≤70%）

# BDP计算（抗丢包适配）：
# 2000Mbps理论速度=250MB/s，RTT=20ms时BDP=5MB
# 缓冲区总占用控制在内存30%以内（约600MB），预留足够空间应对突发丢包

# TCP窗口核心配置（上下行对称+抗丢包）
net.ipv4.tcp_rmem = 2097152 26843545 536870912    # 接收窗口：2MB初始（加速恢复）-256MB-512MB（按2Gbps比例调整）
net.ipv4.tcp_wmem = 2097152 26843545 536870912    # 发送窗口：与接收严格对称
net.core.rmem_default = 134217728                 # 接收默认128MB（对称分配）
net.core.wmem_default = 134217728                 # 发送默认128MB（对称分配）
net.core.rmem_max = 536870912                     # 接收最大512MB（2G内存安全上限）
net.core.wmem_max = 536870912                     # 发送最大512MB（与接收对称）
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_moderate_rcvbuf = 1                  # 动态调整缓冲区（根据丢包自适应）
net.ipv4.tcp_adv_win_scale = -2                   # 激进窗口扩展（降低RTT影响）
net.ipv4.tcp_low_latency = 1                      # 低延迟模式
net.ipv4.tcp_sack = 1                             # 启用SACK（精准定位丢包）
net.ipv4.tcp_fack = 1                             # 转发确认（辅助SACK）
net.ipv4.tcp_timestamps = 1                       # 时间戳（SACK依赖）

# BBR拥塞控制（2000Mbps抗丢包调优）
net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_bbr_high_gain = 2800000000           # 降低增益（适配2Gbps，平衡速度与丢包）
net.ipv4.tcp_bbr_rtt_scaling = 2                  # 中等RTT敏感度（适配2Gbps路径特性）
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_no_metrics_save = 1                  # 减少单线程开销
net.ipv4.tcp_bbr_min_rtt_window = 300000          # 缩短RTT采样窗口（更快检测丢包）
net.ipv4.tcp_bbr_probe_rtt_mode = 1               # 启用RTT探测（预防路径拥塞丢包）

# 单线程性能与丢包恢复
net.ipv4.tcp_limit_output_bytes = 8388608         # 单次发送8MB（2核处理2Gbps能力内）
net.ipv4.tcp_single_stream_allowance = 268435456  # 单流限制256MB（匹配2核）
net.ipv4.tcp_push_pending_frames = 1              # 立即发送（减少缓冲延迟）
net.ipv4.tcp_nodelay = 1                          # 禁用Nagle（小包无延迟）
net.ipv4.tcp_autocorking = 0                      # 禁用自动合并（避免人为延迟）
net.ipv4.tcp_reordering = 8                       # 提高乱序容忍（2Gbps路径更易乱序）
net.ipv4.tcp_early_retrans = 3                    # 早期重传（加速丢包恢复）
net.ipv4.tcp_lost_retransmit = 1                  # 丢包后立即重传

# 网络设备队列（防丢包核心，fq_pie适配）
net.core.netdev_max_backlog = 40000               # 接收队列4万（2Gbps为10Gbps的1/5）
net.core.netdev_budget = 300                      # 单次中断处理包数（2核适配2Gbps）
net.core.netdev_budget_usecs = 1500               # 中断处理时间限制（降低CPU占用）
net.core.dev_weight = 256                         # 设备权重（2核均衡负载）
net.core.optmem_max = 4194304                     # 选项内存4MB（2Gbps适配）
net.core.busy_poll = 200                          # 忙轮询（2核合理利用，降低延迟）
net.core.busy_read = 200                          # 忙读（平衡CPU与延迟）
net.core.default_qdisc = fq_pie                   # 启用fq_pie（替代fq_codel，增强抗丢包）
# FQ_PIE核心参数（2000Mbps抗丢包优化）
net.core.fq_pie.target_delay = 10ms               # 目标延迟10ms（平衡吞吐与延迟）
net.core.fq_pie.max_queue_size = 10000            # 最大队列1万包（2Gbps突发缓冲）
net.core.fq_pie.packet_limit = 2000               # 单流包限制（防止单一流占满队列）
net.core.fq_pie.alpha = 6                         # 低惩罚系数（减少正常波动丢包）
net.core.fq_pie.beta = 12                         # 与alpha匹配（平滑拥塞响应）
net.core.fq_pie.max_burst = 40                    # 允许突发包数（适配2Gbps短脉冲）

# 连接管理（减少连接异常丢包）
net.core.somaxconn = 65536                        # 连接队列6.5万（2核支撑2Gbps）
net.ipv4.tcp_max_syn_backlog = 32768              # SYN队列3.2万（按比例调整）
net.ipv4.tcp_max_tw_buckets = 800000              # TIME_WAIT桶80万（2G内存可控）
net.ipv4.tcp_fin_timeout = 3                      # 适度延长FIN等待（减少半连接丢包）
net.ipv4.tcp_tw_reuse = 1                         # 重用TIME_WAIT（节省资源）
net.ipv4.tcp_orphan_retries = 2                   # 增加重试（减少意外丢包）
net.ipv4.tcp_abort_on_overflow = 0                # 溢出时缓冲而非直接丢包
net.ipv4.tcp_dsack = 1                            # 重复SACK（精准定位丢包）
net.ipv4.tcp_syncookies = 1                       # 防御SYN泛洪丢包

# 超时与重传（加速丢包恢复）
net.ipv4.tcp_keepalive_time = 30                  # 保活探测30秒（平衡资源与连接稳定性）
net.ipv4.tcp_keepalive_intvl = 3                  # 探测间隔3秒
net.ipv4.tcp_keepalive_probes = 4                 # 探测次数4次
net.ipv4.ip_local_port_range = 1024 65535
net.ipv4.tcp_retries1 = 2                         # 初始重传等待减少
net.ipv4.tcp_retries2 = 7                         # 最大重传次数适中
net.ipv4.tcp_rto_min = 150                        # 最小重传超时150ms（更快恢复）
net.ipv4.tcp_rto_max = 1500                       # 最大重传超时1.5s（避免过长等待）

# 内存管理（2G内存抗丢包保障）
vm.swappiness = 0                                 # 禁用交换（交换=高延迟+丢包）
vm.min_free_kbytes = 262144                       # 保留256MB空闲内存（应对突发）
vm.dirty_ratio = 12                               # 脏页比率12%（避免I/O阻塞丢包）
vm.dirty_background_ratio = 6                     # 后台脏页6%
vm.dirty_writeback_centisecs = 70                 # 70ms刷盘一次（平衡I/O与延迟）
vm.page-cluster = 0                               # 禁用预读（消除延迟）
vm.max_map_count = 262144                         # 映射限制（2G适配）

# 系统限制（2核支撑配置）
fs.file-max = 1500000                             # 文件描述符150万（2Gbps适配）
fs.nr_open = 3000000                              # 进程描述符300万
net.ipv4.tcp_max_orphans = 50000                  # 孤儿连接限制（2核适配）

# 处理器调度（2核抗丢包优化，适配AMD EPYC 7663）
kernel.sched_migration_cost_ns = 150000           # 进程迁移成本（2核均衡负载）
kernel.sched_autogroup_enabled = 0                # 禁用自动分组
kernel.sched_latency_ns = 1500000                 # 调度延迟1.5ms（快速响应）
kernel.sched_wakeup_granularity_ns = 300000       # 唤醒粒度0.3ms
kernel.softirq_prio = 6                           # 提高软中断优先级（确保丢包处理）

# 硬件加速（2核扛2000Mbps关键）
net.ipv4.tcp_tso = 1                              # 发送分段卸载（节省CPU）
net.ipv4.tcp_gro = 1                              # 接收聚合卸载
net.ipv4.tcp_lro = 1                              # 大型接收卸载（AMD EPYC 7663支持良好）
net.ipv4.tcp_ecn = 2                              # 启用ECN（用标记替代丢包）
net.core.netdev_features = 0xffffffff             # 启用所有支持的网卡特性
